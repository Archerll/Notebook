# MySQL 深入浅出

## 事务

### 如何避免长事务对业务的影响

从开发应用端来看：

1. 确认是否使用了set autocommit = 0。
2. 确认是否有只读事务，将只读事务删除。
3. 业务连接数据库时，根据对业务本身的预估，通过set MAX_EXECUTION_TIME 命令，来控制每个语句最大执行时间。

从数据库端来看：

1. 监控 information_schema.Innodb_trx 表，设置长事务阈值，超过就报警 / 或者 kill；
2. Percona 的 pt-kill 这个工具不错，推荐使用；
3. 在业务功能测试阶段要求输出所有的 general_log，分析日志行为提前发现问题；
4. 如果使用的是 MySQL  5.6 或者更新版本，把 innodb_undo_tablespaces 设置成 2（或更大的值）。如果真的出现大事务导致回滚段过大，这样设置后清理起来更方便。

## 索引

索引是构建在表上的根据一个或多字段进行排序的一种结构，可以加快表中数据的查找速度。

索引通常可以由多种数据结构进行实现：

- B+树索引，这里的B+树的阶数由数据块大小决定（内存页面大小）
- 哈希索引，
- 跳表索引，



### InnoDB的索引模型

在InnoDB中，表中的数据都是以主键顺序构建的索引存储的，这种存储方式是索引组织表。

在InnoDB中，索引是B+树索引。



在InnoDB中，根据叶子的内容，可以将索引分为**主键索引**和**非主键索引** 。

- 在主键索引中，叶子结点存储的是整行的数据。所以也称作是聚簇索引。
- 在非主键索引中，叶子结点存储的是主键。在使用非主键索引进行查找时，首先会通过非主键索引找到数据所对应的主键值，再通过查询主键索引，从而检索出目标数据，这个过程称作**回表**。



B+树是B树的变体，所以在查询是有很好的的性能，但是同样B+树在删除和增加数据时，也要同B树做同样的操作：

1. 根据各节点确定数据需要插入的节点或需要删除数据的节点。
2. 插入时判断节点是否已满。①如果未满则直接插入数据；②如果已满则需要将节点进行分裂，并且对B+树进行调整。
3. 删除时判断节点是否已空。①如果未空则直接删除数据；②如果为空，则需要对该节点进行删除，并且对B+数进行相应的调整。



